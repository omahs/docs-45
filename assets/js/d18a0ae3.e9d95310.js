"use strict";(self.webpackChunkdocs_oasis_dev=self.webpackChunkdocs_oasis_dev||[]).push([[8119],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>c});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),d=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=d(e.components);return a.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=d(t),c=r,h=m["".concat(l,".").concat(c)]||m[c]||u[c]||i;return t?a.createElement(h,o(o({ref:n},p),{},{components:t})):a.createElement(h,o({ref:n},p))}));function c(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=m;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var d=2;d<i;d++)o[d]=t[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},3765:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>d});var a=t(7462),r=(t(7294),t(3905));const i={},o="Handling Network Upgrades",s={unversionedId:"node/run-your-node/maintenance/handling-network-upgrades",id:"node/run-your-node/maintenance/handling-network-upgrades",title:"Handling Network Upgrades",description:"Changes between the major consensus network versions are backward and forward",source:"@site/docs/node/run-your-node/maintenance/handling-network-upgrades.md",sourceDirName:"node/run-your-node/maintenance",slug:"/node/run-your-node/maintenance/handling-network-upgrades",permalink:"/node/run-your-node/maintenance/handling-network-upgrades",draft:!1,editUrl:"https://github.com/oasisprotocol/docs/edit/main/docs/node/run-your-node/maintenance/handling-network-upgrades.md",tags:[],version:"current",lastUpdatedAt:1675933402,formattedLastUpdatedAt:"Feb 9, 2023",frontMatter:{},sidebar:"operators",previous:{title:"Wiping Node State",permalink:"/node/run-your-node/maintenance/wiping-node-state"},next:{title:"Adding or Removing Nodes",permalink:"/node/run-your-node/maintenance/adding-or-removing-nodes"}},l={},d=[{value:"Reaching Upgrade Epoch",id:"reaching-upgrade-epoch",level:2},{value:"Preparing New Genesis File and Wiping State",id:"preparing-new-genesis-file-and-wiping-state",level:2},{value:"Patching Dumped State",id:"patching-dumped-state",level:3},{value:"Download and Verify the Provided Genesis File",id:"verify-genesis",level:3},{value:"Example diff for Mainnet Beta to Mainnet network upgrade",id:"example-diff-for-mainnet-beta-to-mainnet-network-upgrade",level:4},{value:"Wiping State",id:"wiping-state",level:3},{value:"Updating ParaTimes",id:"updating-paratimes",level:2},{value:"Start Your Node",id:"start-your-node",level:2},{value:"Clean Up",id:"clean-up",level:2}],p={toc:d};function u(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"handling-network-upgrades"},"Handling Network Upgrades"),(0,r.kt)("p",null,"Changes between the major consensus network versions are backward and forward\nbreaking. You have to always run ",(0,r.kt)("strong",{parentName:"p"},"a specific version of the Oasis Core to\nfetch and validate the blocks matching the specific consensus network version"),"."),(0,r.kt)("p",null,"There are two kinds of consensus network upgrades that can occur:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Seamless upgrade"),": on-chain upgrade without resetting the consensus state or\nchanging the genesis document (e.g. ",(0,r.kt)("a",{parentName:"li",href:"/node/testnet/upgrade-log#2022-04-04-upgrade"},"Testnet upgrade 2022-04-04"),", ",(0,r.kt)("a",{parentName:"li",href:"/node/mainnet/upgrade-log#2021-08-31-upgrade"},"Mainnet\nupgrade 2021-08-31"),")."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Dump & restore upgrade"),": requires wiping state and starting the upgraded\nnetwork from a fresh genesis document (e.g. ",(0,r.kt)("a",{parentName:"li",href:"/node/mainnet/upgrade-log#damask-upgrade"},"Mainnet upgrade 2022-04-11\n(Damask)"),", ",(0,r.kt)("a",{parentName:"li",href:"/node/testnet/upgrade-log#2022-03-03-upgrade"},"Testnet upgrade 2022-03-03"),").")),(0,r.kt)("p",null,"The specific Oasis Core version requirements also impact the way how you\n",(0,r.kt)("strong",{parentName:"p"},"initially sync your node with the network"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If the last network upgrade was a dump & restore one, then your node will\ncomplete the synchronization automatically by fetching and validating all\nblocks following the state in the genesis document."),(0,r.kt)("li",{parentName:"ul"},"If the last network upgrade was a seamless one, you will first need to\ndownload the older version of the Oasis Core to sync the initial blocks\nand then sequentially perform seamless upgrade(s).")),(0,r.kt)("p",null,"For example, at time of writing this guide in order to sync your node from\nscratch on the ",(0,r.kt)("a",{parentName:"p",href:"/node/testnet/"},"Testnet network")," you needed to do the\nfollowing:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Download the genesis document and run Oasis Core 22.0.x which synced\nblocks from epoch 14209 through (excluding) upgrade epoch 15056."),(0,r.kt)("li",{parentName:"ul"},"Wait until the node automatically stopped, then upgrade to Oasis Core\n22.2.x which synced the blocks from epoch 15056 onwards.")),(0,r.kt)("p",null,"The expected versions of the Oasis Core to sync your node from the latest\ngenesis document on the Mainnet and Testnet are always published on the\n",(0,r.kt)("a",{parentName:"p",href:"/node/mainnet/"},"Network Parameters")," and ",(0,r.kt)("a",{parentName:"p",href:"/node/testnet/"},"Testnet Parameters")," pages respectively."),(0,r.kt)("h2",{id:"reaching-upgrade-epoch"},"Reaching Upgrade Epoch"),(0,r.kt)("p",null,"Once a ",(0,r.kt)("a",{parentName:"p",href:"/node/run-your-node/validator-node/governance"},"governance proposal")," is accepted the node will automatically stop when\nreaching the ",(0,r.kt)("strong",{parentName:"p"},"upgrade epoch")," specified in the proposal. The node will\nwrite something like this in the log:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{"caller":"mux.go:426","level":"debug","module":"abci-mux","msg":"dispatching halt hooks for upgrade","ts":"2022-05-06T13:11:41.721994647Z"}\n')),(0,r.kt)("p",null,"and on the error output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"panic: upgrade: reached upgrade epoch\n")),(0,r.kt)("p",null,"The state of the network at the upgrade epoch height will be automatically\nexported into a genesis file located in\n",(0,r.kt)("inlineCode",{parentName:"p"},"<NODE-DATADIR>/exports/genesis-<CHAIN_ID>-at-<UPGRADE_HEIGHT>.json"),",\nwhere ",(0,r.kt)("inlineCode",{parentName:"p"},"CHAIN_ID")," is the chain ID of the network and ",(0,r.kt)("inlineCode",{parentName:"p"},"LATEST_HEIGHT")," is the\nheight of the last consensus block before the upgrade epoch. This command,\ndepending on the size of the state, may take some time to finish."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"While waiting for the network upgrade epoch, you can check the current height\nand epoch by running:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oasis-node control status -a unix:/serverdir/node/internal.sock\n")),(0,r.kt)("p",{parentName:"admonition"},"and observe the value of the ",(0,r.kt)("inlineCode",{parentName:"p"},"consensus.latest_height")," and\n",(0,r.kt)("inlineCode",{parentName:"p"},"consensus.latest_epoch")," fields respectively.")),(0,r.kt)("p",null,"Once the upgrade epoch is reached, follow the instructions in the corresponding\n",(0,r.kt)("a",{parentName:"p",href:"/node/mainnet/upgrade-log"},"upgrade log"),"."),(0,r.kt)("h2",{id:"preparing-new-genesis-file-and-wiping-state"},"Preparing New Genesis File and Wiping State"),(0,r.kt)("p",null,"For dump & restore upgrades, the exported genesis file needs to be patched and\nverified accordingly. Then, we wipe the existing consensus state including the\nhistory of all transactions and let the node reload the state from the genesis\nfile."),(0,r.kt)("h3",{id:"patching-dumped-state"},"Patching Dumped State"),(0,r.kt)("p",null,"First, let's run a built-in helper which migrates and updates parts of the\ngenesis file which changed in the new version of Oasis Core. We will provide\nthe dumped genesis file as the input and write the new version of the genesis\nfile into ",(0,r.kt)("inlineCode",{parentName:"p"},"genesis_dump.json"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oasis-node debug fix-genesis --genesis.file genesis-<CHAIN_ID>-at-<LATEST_HEIGHT>.json --genesis.new_file genesis_dump.json\n")),(0,r.kt)("p",null,"Other parts of the genesis need to be updated manually, as described in each\nupgrade's ",(0,r.kt)("em",{parentName:"p"},"Proposed State Changes")," section (e.g. ",(0,r.kt)("a",{parentName:"p",href:"/node/mainnet/damask-upgrade#proposed-state-changes"},"Damask upgrade's Proposed\nState Changes"),", ",(0,r.kt)("a",{parentName:"p",href:"/node/mainnet/previous-upgrades/cobalt-upgrade#proposed-state-changes"},"Cobalt upgrade's Proposed State Changes"),")."),(0,r.kt)("h3",{id:"verify-genesis"},"Download and Verify the Provided Genesis File"),(0,r.kt)("p",null,"In addition, download the new genesis file linked in the ",(0,r.kt)("a",{parentName:"p",href:"/node/mainnet/"},"Network Parameters"),"\nand save it as ",(0,r.kt)("inlineCode",{parentName:"p"},"/serverdir/etc/genesis.json"),"."),(0,r.kt)("p",null,"Compare the dumped state with the downloaded genesis file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"diff --unified=3 genesis_dump.json genesis.json\n")),(0,r.kt)("p",null,"If you obtain the same result, then you have successfully verified the provided\ngenesis file!"),(0,r.kt)("h4",{id:"example-diff-for-mainnet-beta-to-mainnet-network-upgrade"},"Example diff for Mainnet Beta to Mainnet network upgrade"),(0,r.kt)("p",null,"Let's look at what ",(0,r.kt)("inlineCode",{parentName:"p"},"diff")," returned before performing manual changes to the\ngenesis file for the Mainnet network upgrade:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-diff"},'--- genesis_dump.json    2020-11-16 17:49:46.864554271 +0100\n+++ genesis.json    2020-11-16 17:49:40.353496022 +0100\n@@ -1,7 +1,7 @@\n {\n   "height": 702000,\n-  "genesis_time": "2020-11-18T13:38:00Z",\n-  "chain_id": "mainnet-beta-2020-10-01-1601568000",\n+  "genesis_time": "2020-11-18T16:00:00Z",\n+  "chain_id": "oasis-1",\n   "epochtime": {\n     "params": {\n       "interval": 600\n@@ -2506,1563 +2506,1779 @@\n       "debonding_interval": 336,\n       "reward_schedule": [\n         {\n-          "until": 3696,\n-          "scale": "1595"\n+          "until": 4842,\n+          "scale": "2081"\n         },\n         {\n-          "until": 3720,\n-          "scale": "1594"\n+          "until": 4866,\n+          "scale": "2080"\n         },\n\n        ... trimmed ...\n\n         {\n-          "until": 35712,\n+          "until": 36882,\n           "scale": "2"\n         },\n         {\n-          "until": 35760,\n+          "until": 36930,\n           "scale": "1"\n         }\n       ],\n@@ -4087,7 +4303,6 @@\n         "transfer": 1000\n       },\n       "min_delegation": "100000000000",\n-      "disable_transfers": true,\n       "fee_split_weight_propose": "2",\n       "fee_split_weight_vote": "1",\n       "fee_split_weight_next_propose": "1",\n@@ -4097,7 +4312,7 @@\n     "token_symbol": "ROSE",\n     "token_value_exponent": 9,\n     "total_supply": "10000000000000000000",\n-    "common_pool": "1835039672187348312",\n+    "common_pool": "2285039672187348312",\n     "last_block_fees": "0",\n     "ledger": {\n       "oasis1qp0l8r2s3076n4xrq8av0uuqegj7z9kq55gu5exy": {\n@@ -6419,7 +6634,7 @@\n       },\n       "oasis1qrad7s7nqm4gvyzr8yt2rdk0ref489rn3vn400d6": {\n         "general": {\n-          "balance": "1633038701000000000"\n+          "balance": "1183038701000000000"\n         },\n         "escrow": {\n           "active": {\n@@ -9862,6 +10077,8 @@\n       }\n     }\n   },\n-  "halt_epoch": 1440,\n-  "extra_data": null\n+  "halt_epoch": 9940,\n+  "extra_data": {\n+    "quote": "UXVpcyBjdXN0b2RpZXQgaXBzb3MgY3VzdG9kZXM/IFtzdWJtaXR0ZWQgYnkgT2FzaXMgQ29tbXVuaXR5IE1lbWJlciBEYW5peWFyIEJvcmFuZ2F6aXlldl0="\n+  }\n }\n')),(0,r.kt)("p",null,"We can observe that the provided genesis file mostly updates some particular\nnetwork parameters. In addition, some ROSE tokens were transferred from an\naccount to the Common Pool. All other things remained unchanged."),(0,r.kt)("p",null,"Let's break down the diff and explain what has changed."),(0,r.kt)("p",null,"The following genesis file fields will always change on a network upgrade:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"chain_id"),": A unique ID of the network. Mainnet upgrades follow a pattern ",(0,r.kt)("inlineCode",{parentName:"li"},"oasis-1"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"oasis-2"),", ..."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"genesis_time"),": Time from which the genesis file is valid."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"halt_epoch"),": The epoch when the node will stop functioning. We set this to\nintentionally force an upgrade.")),(0,r.kt)("p",null,"The following fields were a particular change in this upgrade:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"staking.params.reward_schedule"),": This field describes the staking reward\nmodel. It was changed to start at 20% (annualized) and range from 20% to 2%\nover the first 4 years of the network. For more details, see the ",(0,r.kt)("a",{parentName:"li",href:"/general/oasis-network/token-metrics-and-distribution"},"Token\nMetrics and Distribution")," doc."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"staking.params.disable_transfers"),": This field was removed to enable token\ntransfers."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"staking.common_pool"),": This field represents the Common Pool. Its balance was\nincreased by 450M ROSE to fund increased staking rewards."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"staking.ledger.oasis1qrad7s7nqm4gvyzr8yt2rdk0ref489rn3vn400d6"),": This field\ncorresponds to the Community and Ecosystem Wallet. Its ",(0,r.kt)("inlineCode",{parentName:"li"},"general.balance")," was\nreduced by 450M ROSE and transferred to the Common Pool to fund increased\nstaking rewards."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"extra_data"),": This field can hold network's extra data, but is currently\nignored everywhere. For this upgrade, we changed it back to the value in the\nMainnet Beta genesis file to include the Oasis network's genesis quote:\n",(0,r.kt)("em",{parentName:"li"},"\u201d"),(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Quis_custodiet_ipsos_custodes%3F"},(0,r.kt)("em",{parentName:"a"},"Quis custodiet ipsos custodes?")),(0,r.kt)("em",{parentName:"li"},"\u201d ","[","submitted by Oasis Community Member Daniyar Borangaziyev","]","."))),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"The balances in the genesis file are enumerated in base units with 1 ROSE token\nequaling 10^9 (i.e. billion) base units. For more details, see the\n",(0,r.kt)("a",{parentName:"p",href:"/node/genesis-doc#parameters"},"Genesis Document"),".")),(0,r.kt)("h3",{id:"wiping-state"},"Wiping State"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"We do not suggest that you wipe ",(0,r.kt)("em",{parentName:"p"},"all")," state. You might lose node identities and\nkeys if you do it this way.")),(0,r.kt)("p",null,"The process is described in the\n",(0,r.kt)("a",{parentName:"p",href:"/node/run-your-node/maintenance/wiping-node-state#state-wipe-and-keep-node-identity"},"Wiping Node State"),"\ndocument."),(0,r.kt)("h2",{id:"updating-paratimes"},"Updating ParaTimes"),(0,r.kt)("p",null,"If you are running a compute or a client ParaTime node, you will often need to\nupgrade the ParaTime. The required ParaTime versions are stored in the network\nregistry. The command below queries the registry and extracts the version\ninformation for the Paratime\n",(0,r.kt)("inlineCode",{parentName:"p"},"00000000000000000000000000000000000000000000000072c8215e60d5bca7"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oasis-node registry runtime list -v -a unix:/serverdir/node/internal.sock \\| \njq 'select(.id==\"00000000000000000000000000000000000000000000000072c8215e60d5bca7\") | .deployments'\n")),(0,r.kt)("p",null,"At time of writing the Emerald ParaTime on Testnet has the following record:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[\n  {\n    "version": {\n      "major": 7,\n      "minor": 1\n    },\n    "valid_from": 14320\n  },\n  {\n    "version": {\n      "major": 8\n    },\n    "valid_from": 15056\n  }\n]\n')),(0,r.kt)("p",null,"The record above specifies that after epoch 14320, Emerald version 7.1.0 is\nrequired and from epoch 15056, Emerald 8.0.0. If you are running a compute\nnode, ",(0,r.kt)("strong",{parentName:"p"},"the installed ParaTime version must match exactly the ParaTime version\nin the registry"),"! If you are running a client node, ParaTime state syncing\nwill be performed regardless of the version installed."),(0,r.kt)("p",null,"Oasis node supports configuring multiple versions of ParaTime bundles, for\nexample: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"runtime:\n  paths:\n    - /path/to/emerald-paratime-7.1.0-testnet.orc\n    - /path/to/emerald-paratime-8.0.0-testnet.orc\n")),(0,r.kt)("p",null,"The node will then automatically run the correct version of the ParaTime as\nspecified in the registry."),(0,r.kt)("h2",{id:"start-your-node"},"Start Your Node"),(0,r.kt)("p",null,"This will depend on your process manager. If you don't have a process manager,\nyou should use one. However, to start the node without a process manager you\ncan start the ",(0,r.kt)("a",{parentName:"p",href:"/node/run-your-node/prerequisites/oasis-node"},"Oasis Node")," like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oasis-node --config /serverdir/etc/config.yml\n")),(0,r.kt)("h2",{id:"clean-up"},"Clean Up"),(0,r.kt)("p",null,"After you're comfortable with your node deployment, you can remove the old\nOasis Core version and the intermediate\n",(0,r.kt)("inlineCode",{parentName:"p"},"genesis-<CHAIN_ID>-at-<LATEST_HEIGHT>.json")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"genesis_dump.json")," files."))}u.isMDXComponent=!0}}]);