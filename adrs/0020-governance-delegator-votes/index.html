<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-adrs/0020-governance-delegator-votes">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">ADR 0020: Governance Support for Delegator Votes | Oasis Network Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.oasis.io/adrs/0020-governance-delegator-votes"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ADR 0020: Governance Support for Delegator Votes | Oasis Network Documentation"><meta data-rh="true" name="description" content="Component"><meta data-rh="true" property="og:description" content="Component"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.oasis.io/adrs/0020-governance-delegator-votes"><link data-rh="true" rel="alternate" href="https://docs.oasis.io/adrs/0020-governance-delegator-votes" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.oasis.io/adrs/0020-governance-delegator-votes" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.03bfe953.css">
<link rel="preload" href="/assets/js/runtime~main.df39c847.js" as="script">
<link rel="preload" href="/assets/js/main.4ff8f277.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OPF Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="OPF Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Oasis Docs</b></a><a class="navbar__item navbar__link" href="/general/">Use Oasis</a><a class="navbar__item navbar__link" href="/get-involved/">Get Involved</a><a class="navbar__item navbar__link" href="/node/">Run Node</a><a class="navbar__item navbar__link" href="/dapp/">Create dApp</a><a class="navbar__item navbar__link" href="/paratime/">Build ParaTime</a><a class="navbar__item navbar__link" href="/core/">Develop Core</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/oasisprotocol" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub repository" aria-label="GitHub repository"></a><a href="https://oasisprotocol.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-www-link" title="Oasis Protocol Foundation website" aria-label="Oasis Protocol Foundation website"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/adrs">Architectural Decision Records</a><button aria-label="Toggle the collapsible sidebar category &#x27;Architectural Decision Records&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0001-tm-multi-root-apphash">ADR 0001: Multiple Roots Under the Tendermint Application Hash</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0002-go-modules-compatible-git-tags">ADR 0002: Go Modules Compatible Git Tags</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0003-consensus-runtime-token-transfer">ADR 0003: Consensus/Runtime Token Transfer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0004-runtime-governance">ADR 0004: Runtime Governance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0005-runtime-compute-slashing">ADR 0005: Runtime Compute Node Slashing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0006-consensus-governance">ADR 0006: Consensus Governance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0007-improved-random-beacon">ADR 0007: Improved Random Beacon</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0008-standard-account-key-generation">ADR 0008: Standard Account Key Generation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0009-ed25519-semantics">ADR 0009: Ed25519 Signature Verification Semantics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0010-vrf-elections">ADR 0010: VRF-based Committee Elections</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0011-incoming-runtime-messages">ADR 0011: Incoming Runtime Messages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0012-runtime-message-results">ADR 0012: Runtime Message Results</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0013-runtime-upgrades">ADR 0013: Runtime Upgrade Improvements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0014-runtime-signing-tx-with-hardware-wallet">ADR 0014: Signing Runtime Transactions with Hardware Wallet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0015-vrf-per-block-entropy">ADR 0015: Randomized Paratime Proposer Selection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0016-consensus-parameters-change-proposal">ADR 0016: Consensus Parameters Change Proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0017-app-standards">ADR 0017: ParaTime Application Standard Proposal Process</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/adrs/0020-governance-delegator-votes">ADR 0020: Governance Support for Delegator Votes</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ADR 0020: Governance Support for Delegator Votes</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="component">Component<a class="hash-link" href="#component" title="Direct link to heading">​</a></h2><p>Oasis Core</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="changelog">Changelog<a class="hash-link" href="#changelog" title="Direct link to heading">​</a></h2><ul><li>2022-11-07: Minor updates. Added Cosmos-SDK implementation note.</li><li>2022-11-03: Added benchmarks, minor updates.</li><li>2022-11-02: Initial draft.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a class="hash-link" href="#status" title="Direct link to heading">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a class="hash-link" href="#context" title="Direct link to heading">​</a></h2><p>With the current governance voting mechanism (<a href="/adrs/0004-runtime-governance">ADR 04</a>), only the active
validator set is participating in voting. This means that the validators are
voting on behalf of all their delegators. This ADR proposes a change so that
each delegator is able to vote with its own stake. The delegators vote acts as
an override of the validator vote.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a class="hash-link" href="#decision" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="casting-votes">Casting Votes<a class="hash-link" href="#casting-votes" title="Direct link to heading">​</a></h3><p>In the current implementation the submitter of a vote needs to be a part of the
active validator committee at the time the vote is cast. This requirement is
relaxed so that additionally anyone with a delegation to an active validator
committee entity can vote.</p><p>This change requires an efficient <code>staking.DelegationsFor</code> query to obtain a
list of accounts the submitter is delegating to. Staking state is updated with:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// delegationKeyReverseFmt is the key format used for reverse mapping of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// delegations (delegator address, escrow address).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Value is CBOR-serialized delegation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delegationKeyReverseFmt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> keyformat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x5A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">staking</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">staking</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>state.SetDelegation</code> function is updated to store both <code>delegationKeyFmt</code> and
the reverse <code>delegationKeyReverseFmt</code>. <code>DelegationsFor</code> query function is
updated to use the added reverse mapping.</p><p>For completeness the same can be done for debonding delegations, although not
necessary for the governance changes proposed in this ADR.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="alternative-solutions">Alternative solutions<a class="hash-link" href="#alternative-solutions" title="Direct link to heading">​</a></h4><p>Possible alternatives that would avoid adding the reverse mapping are:</p><ul><li>Querying <code>DelegationsTo</code> for each validator. This results in <code>num_validators</code>
queries per cast vote transaction which is still too much.</li><li>Allowing anyone to cast votes. Potentially a viable solution, but this could
result in the number of voters growing uncontrollably large. This might be ok,
if the vote tallying procedure would ignore those votes. However the votes
state could still grow problematically big.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vote-tallying">Vote tallying<a class="hash-link" href="#vote-tallying" title="Direct link to heading">​</a></h3><p>When a proposal closes, the vote tallying procedure changes to:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Two-pass over votes approach.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1  Tally up the validator votes (as it is already implemented) # First pass.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2  For each of the voters do:                                  # Second pass.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3    For each of the entities voter delegates to:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4      Skip non validator entities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5      Skip if voter&#x27;s vote matches the delegation entity vote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6      Compute stake from the delegation shares</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4      If delegation entity voted, subtract the stake from the delegation entity vote tally</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5      Add computed stake to the voter&#x27;s vote tally</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Possbile variant: instead of using <code>DelegationsFor</code> query in step 3), a map of
all validator delegators could be prebuild, by using <code>DelegationTo</code> for each
of the validators. Even with the efficient <code>DelegationsFor</code> query, this can be
beneficial IF the number of voters is large.</li></ul><p>This procedure iterates over all voters and can be beneficial if the number of
voters is relatively low compared to the number of all validator delegators.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="alternative-vote-tallying-procedures">Alternative Vote Tallying procedures<a class="hash-link" href="#alternative-vote-tallying-procedures" title="Direct link to heading">​</a></h4><p>A possible alternative would be to iterate over the delegators-validator sets:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Delegators-validator pass approach.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 Precompute stakes for all delegators to validators from shares.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2 For each validator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3   For each delegator to the validator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4     IF validator and delegators votes match (or delegator didn&#x27;t vote)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5       Add delegator stake to the validator&#x27;s vote (or nothing if validator didn&#x27;t vote)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6     IF validator and delegator vote don&#x27;t match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7       Add delegator stake to the delegator&#x27;s vote (or nothing if delegator didn&#x27;t vote)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The voting procedure now iterates over all delegators of the active validator
set. The amount of work is somewhat predictable as it doesn&#x27;t depend on the
number of voters but on the delegators-to-validator sets. However the number of
votes is bound by the size of the delegators-to-validator set and in realistic
scenario likely much smaller.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="implementations-in-other-chains">Implementations in other chains<a class="hash-link" href="#implementations-in-other-chains" title="Direct link to heading">​</a></h4><p>Cosmos-SDK uses a similar approach to the proposed solution in the ADR. The
tallying iterates over voters, their delegations and validators. For detailed
implementation see: <a href="https://github.com/cosmos/cosmos-sdk/blob/dc004c85f2e8b8fb4f66caac2703228c5bf544cf/x/gov/keeper/tally.go#L37-L90" target="_blank" rel="noopener noreferrer">Cosmos-SDK Vote Tallying Code</a>. The voting itself is
limited to delegators (similar as proposed in this document).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarks">Benchmarks<a class="hash-link" href="#benchmarks" title="Direct link to heading">​</a></h4><p>The Vote Tallying procedure variants were benchmarked on mainnet data.</p><p>Some basic stats from mainnet:</p><ul><li>120 validators</li><li>~49500 eligible voters (unique delegators to validators)</li><li>average number of delegations-to per account is 1</li></ul><p>The variants were benchmarked in scenarios with different number of voters. In
all scenarios the mainnet consensus state was used, only the number of
(simulated) voters varied. All votes were eligible (had at least one delegation
to an active validator) and all of the delegator votes did override the
validator votes.</p><p>The three tested variants were:</p><ul><li>&quot;Two pass over voters (optimized DelegationsFor)&quot; - as described in the
proposed Vote tallying solution. Reverse mapping key is used for the
<code>DelegationsFor</code> queries (described in Casting Votes section).</li><li>&quot;Two pass over voters (pre-build validator escrow)&quot; - as described in the
proposed Vote tallying solution with modification of prebuilding a map of all
validator delegators (mentioned in the &quot;Possible variant&quot; section).</li><li>&quot;Validator-delegators&quot; - as described in the alternatives section.</li></ul><p><img loading="lazy" alt="Two pass over voters (optimized DelegationsFor)" src="/assets/images/0020-bench1-b406915bd71a67020495939d2c89075b.png" width="720" height="576" class="img_ev3q">
<img loading="lazy" alt="Two pass over voters (pre-build validators escrow)" src="/assets/images/0020-bench2-1cc7812d2c015e4a03288cc6f165bb4e.png" width="720" height="576" class="img_ev3q">
<img loading="lazy" alt="Validator-delegators" src="/assets/images/0020-bench3-8741906103d267c9119ac66826d39bd1.png" width="720" height="576" class="img_ev3q"></p><p>The above results show that:</p><ul><li>Two-pass approach (querying <code>DelegationsFor</code> for every voter) is fastest up to
about 25000 voters for a proposal. In the worst case (every eligible voter
voted) it is about twice as slow as the alternatives. In that case the
tallying took about 3 seconds.</li><li>The two-pass approach using pre-built map of all validator delegators is
comparable to the &quot;Validator-delegators&quot; procedure. This makes sense as in
both cases the main work is done in querying the delegators of validators.</li></ul><p>In reality, the number of voters will likely be small compared to the eligible
set of all delegators, so the two-pass approach (with querying <code>DelegationsFor</code>
for every voter) seems to make the most sense.</p><p>If number of voters ever becomes problematic, the method could also implement a
heuristic to use the prebuilt validator-delegators map when the number of voters
is large (e.g. number of voters &gt; 1/2 eligible delegators), but at the moment
there is no efficient way to query the number of all delegators.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pruning">Pruning<a class="hash-link" href="#pruning" title="Direct link to heading">​</a></h3><p>With the possibility of increased number of votes per proposal a pruning of
votes can be implemented. Votes for a proposal can be pruned as soon as the
first block after the proposal is closed. Because proposal is closed in the
<code>EndBlock</code> state (which includes votes received in this last block), the pruning
should not be done before the block after, so that the exact state at the time
of the closing can be queried.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="voting-via-messages">Voting via messages<a class="hash-link" href="#voting-via-messages" title="Direct link to heading">​</a></h3><p>Delegator can also be a runtime. For enabling runtimes to vote, casting votes
should also be supported via runtime messages.</p><p>Roothash message type is updated to include governance message field:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Message </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Staking    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StakingMessage    </span><span class="token string" style="color:#e3116c">`json:&quot;staking,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Registry   </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RegistryMessage   </span><span class="token string" style="color:#e3116c">`json:&quot;registry,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Governance </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">GovernanceMessage </span><span class="token string" style="color:#e3116c">`json:&quot;governance,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// GovernanceMessage is a governance message that allows a runtime to perform governance operations.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GovernanceMessage </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cbor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Versioned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CastVote </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">governance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ProposalVote </span><span class="token string" style="color:#e3116c">`json:&quot;cast_vote,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Governance backend is updated to handle the cast vote message.</p><p>For completeness, support for submitting proposals via runtime messages can also
be implemented.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a class="hash-link" href="#consequences" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive">Positive<a class="hash-link" href="#positive" title="Direct link to heading">​</a></h3><ul><li>Delegators are able to override validators vote. In the case of unresponsive
validators this increases the voting participation.</li><li>Delegators are able to vote with their own stake.</li><li>(if implemented) Staking <code>DelegationsFor</code> queries are now efficient and don&#x27;t
require scanning the full delegations state.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative">Negative<a class="hash-link" href="#negative" title="Direct link to heading">​</a></h3><ul><li>This increases the complexity of the vote tallying procedure.</li><li>This increases the size of the governance votes state.</li><li>This increases the complexity and size of the consensus staking state if the
<code>DelegationsFor</code> reverse mapping is implemented.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="neutral">Neutral<a class="hash-link" href="#neutral" title="Direct link to heading">​</a></h3></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/oasisprotocol/adrs/edit/main/0020-governance-delegator-votes.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-01-23T16:21:40.000Z">Jan 23, 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/adrs/0017-app-standards"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ADR 0017: ParaTime Application Standard Proposal Process</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#component" class="table-of-contents__link toc-highlight">Component</a></li><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#casting-votes" class="table-of-contents__link toc-highlight">Casting Votes</a></li><li><a href="#vote-tallying" class="table-of-contents__link toc-highlight">Vote tallying</a></li><li><a href="#pruning" class="table-of-contents__link toc-highlight">Pruning</a></li><li><a href="#voting-via-messages" class="table-of-contents__link toc-highlight">Voting via messages</a></li></ul></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li><li><a href="#neutral" class="table-of-contents__link toc-highlight">Neutral</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/pJdWeVtmHT" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Watch us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UC35UFPcZ2F1wjPxhPrSsESQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Oasis Protocol Foundation. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.df39c847.js"></script>
<script src="/assets/js/main.4ff8f277.js"></script>
</body>
</html>