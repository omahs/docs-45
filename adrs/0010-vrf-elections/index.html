<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-adrs/0010-vrf-elections">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">ADR 0010: VRF-based Committee Elections | Oasis Network Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.oasis.io/adrs/0010-vrf-elections"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ADR 0010: VRF-based Committee Elections | Oasis Network Documentation"><meta data-rh="true" name="description" content="Component"><meta data-rh="true" property="og:description" content="Component"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.oasis.io/adrs/0010-vrf-elections"><link data-rh="true" rel="alternate" href="https://docs.oasis.io/adrs/0010-vrf-elections" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.oasis.io/adrs/0010-vrf-elections" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.03bfe953.css">
<link rel="preload" href="/assets/js/runtime~main.df39c847.js" as="script">
<link rel="preload" href="/assets/js/main.4ff8f277.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OPF Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="OPF Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Oasis Docs</b></a><a class="navbar__item navbar__link" href="/general/">Use Oasis</a><a class="navbar__item navbar__link" href="/get-involved/">Get Involved</a><a class="navbar__item navbar__link" href="/node/">Run Node</a><a class="navbar__item navbar__link" href="/dapp/">Create dApp</a><a class="navbar__item navbar__link" href="/paratime/">Build ParaTime</a><a class="navbar__item navbar__link" href="/core/">Develop Core</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/oasisprotocol" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub repository" aria-label="GitHub repository"></a><a href="https://oasisprotocol.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-www-link" title="Oasis Protocol Foundation website" aria-label="Oasis Protocol Foundation website"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/adrs">Architectural Decision Records</a><button aria-label="Toggle the collapsible sidebar category &#x27;Architectural Decision Records&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0001-tm-multi-root-apphash">ADR 0001: Multiple Roots Under the Tendermint Application Hash</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0002-go-modules-compatible-git-tags">ADR 0002: Go Modules Compatible Git Tags</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0003-consensus-runtime-token-transfer">ADR 0003: Consensus/Runtime Token Transfer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0004-runtime-governance">ADR 0004: Runtime Governance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0005-runtime-compute-slashing">ADR 0005: Runtime Compute Node Slashing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0006-consensus-governance">ADR 0006: Consensus Governance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0007-improved-random-beacon">ADR 0007: Improved Random Beacon</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0008-standard-account-key-generation">ADR 0008: Standard Account Key Generation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0009-ed25519-semantics">ADR 0009: Ed25519 Signature Verification Semantics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/adrs/0010-vrf-elections">ADR 0010: VRF-based Committee Elections</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0011-incoming-runtime-messages">ADR 0011: Incoming Runtime Messages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0012-runtime-message-results">ADR 0012: Runtime Message Results</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0013-runtime-upgrades">ADR 0013: Runtime Upgrade Improvements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0014-runtime-signing-tx-with-hardware-wallet">ADR 0014: Signing Runtime Transactions with Hardware Wallet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0015-vrf-per-block-entropy">ADR 0015: Randomized Paratime Proposer Selection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0016-consensus-parameters-change-proposal">ADR 0016: Consensus Parameters Change Proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0017-app-standards">ADR 0017: ParaTime Application Standard Proposal Process</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0020-governance-delegator-votes">ADR 0020: Governance Support for Delegator Votes</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ADR 0010: VRF-based Committee Elections</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="component">Component<a class="hash-link" href="#component" title="Direct link to heading">​</a></h2><p>Oasis Core</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="changelog">Changelog<a class="hash-link" href="#changelog" title="Direct link to heading">​</a></h2><ul><li>2021-05-10: Initial version</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a class="hash-link" href="#status" title="Direct link to heading">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a class="hash-link" href="#context" title="Direct link to heading">​</a></h2><p>While functional, the current PVSS-based random beacon is neither all that
performant, nor all that scalable.  To address both concerns, this ADR
proposes transitioning the election procedure to one that is based on
cryptographic sortition of Verifiable Random Function (VRF) outputs.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a class="hash-link" href="#decision" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cryptographic-primitives">Cryptographic Primitives<a class="hash-link" href="#cryptographic-primitives" title="Direct link to heading">​</a></h3><p>Let the VRF to be used across the system be ECVRF-EDWARDS25519-SHA512-ELL2
from the <a href="https://datatracker.ietf.org/doc/draft-irtf-cfrg-vrf/" target="_blank" rel="noopener noreferrer">Verifiable Random Functions (VRFs) draft (v10)</a>, with the
following additions and extra clarifications:</p><ul><li><p>All public keys MUST be validated via the &quot;ECVRF Validate Key&quot; procedure
as specified in section 5.6.1 (Small order public keys MUST be
rejected).</p></li><li><p>The string_to_point routine MUST reject non-canonically encoded points
as specified in RFC 8032.  Many ed25519 implementations are lax about
enforcing this when decoding.</p></li><li><p>When decoding s in the ECVRF_verify routine, the s scalar MUST fall
within the range 0 &lt;= i &lt; L.  This change will make proofs
non-malleable.  Note that this check is unneeded for the c scalar
as it is 128-bits, and thus will always lie within the valid range.
This check was not present in the IETF draft prior to version 10.</p></li><li><p>Implementations MAY choose to incorporate additional randomness into
the ECVRF_nonce_generation_RFC8032 function.  Note that proofs (pi_string)
are not guaranteed to be unique or deterministic even without this
extension (the signer can use any arbitrary value for the nonce and
produce a valid proof, without altering beta_string).</p></li></ul><p>Let the tuple oriented cryptographic hash function be TupleHash256 from
<a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-185.pdf" target="_blank" rel="noopener noreferrer">NIST SP 800-185</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="node-descriptor-changes">Node Descriptor Changes<a class="hash-link" href="#node-descriptor-changes" title="Direct link to heading">​</a></h3><p>The node descriptor of each node will be extended to include the following
datastructure.</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Node struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ... existing fields omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // VRF is the public key used by the node to generate VRF proofs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  VRF *VRFInfo `json:&quot;vrf,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type VRFInfo struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ID is the unique identifier of the node used to generate VRF proofs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ID signature.PublicKey `json:&quot;id&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The VRF public key shall be a long-term Ed25519 public key, that is distinct
from every other key used by the node.  The key MUST not be small order.</p><p>The existing <code>Beacon</code> member of the node descriptor is considered deprecated
and will first be ignored by the consensus layer, and then removed in a
subsequent version following a transitionary period.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consensus-parameters">Consensus Parameters<a class="hash-link" href="#consensus-parameters" title="Direct link to heading">​</a></h3><p>The scheduler module will have the following additional consensus parameters
that control behavior.</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type ConsensusParameters struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ... existing fields omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // VRFParameters is the paramenters for the VRF-based cryptographic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // sortition based election system.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  VRFParameters *VRFParameters `json:&quot;vrf_params&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// VRFParameters are the VRF scheduler parameters.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type VRFParameters struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // AlphaHighQualityThreshold is the minimum number of proofs (Pi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // that must be received for the next input (Alpha) to be considered</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // high quality.  If the VRF input is not high quality, runtimes will</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // be disabled for the next epoch.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AlphaHighQualityThreshold uint64 `json:&quot;alpha_hq_threshold,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Interval is the epoch interval (in blocks).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Interval int64 `json:&quot;interval,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ProofSubmissionDelay is the wait peroid in blocks after an epoch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // transition that nodes MUST wait before attempting to submit a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // VRF proof for the next epoch&#x27;s elections.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ProofSubmissionDelay int64 `json:&quot;proof_delay,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // PrevState is the VRF state from the previous epoch, for the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // current epoch&#x27;s elections.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PrevState *PrevVRFState `json:&quot;prev_state,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// PrevVRFState is the previous epoch&#x27;s VRF state that is to be used for</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// elections.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type PrevVRFState struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Pi is the accumulated pi_string (VRF proof) outputs for the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // previous epoch.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pi map[signature.PublicKey]*signature.Proof `json:&quot;pi.omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // CanElectCommittees is true iff the previous alpha was generated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // from high quality input such that committee elections are possible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CanElectCommittees bool `json:&quot;can_elect,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consensus-state-events-and-transactions">Consensus State, Events, and Transactions<a class="hash-link" href="#consensus-state-events-and-transactions" title="Direct link to heading">​</a></h3><p>The scheduler component will maintain and make available the following additonal
consensus state.</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// VRFState is the VRF scheduler state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type VRFState struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Epoch is the epoch for which this alpha is valid.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Epoch EpochTime `json:&quot;epoch&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Alpha is the active VRF alpha_string input.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Alpha []byte `json:&quot;alpha&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Pi is the accumulated pi_string (VRF proof) outputs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pi map[signature.PublicKey]*signature.Proof `json:&quot;pi,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // AlphaIsHighQuality is true iff the alpha was generated from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // high quality input such that elections will be possible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AlphaIsHighQuality bool `json:&quot;alpha_hq&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // SubmitAfter is the block height after which nodes may submit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // VRF proofs for the current epoch.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SubmitAfter int64 `json:&quot;submit_after&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Implementations MAY cache the beta_string values that are generated from valid
pi_strings for performance reasons, however as this is trivial to recalculate,
it does not need to be explicitly exposed.</p><p>Upon epoch transition, the scheduler will emit the following event.</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// VRFEvent is the VRF scheduler event.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type VRFEvent struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Epoch is the epoch that Alpha is valid for.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Epoch EpochTime `json:&quot;epoch,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Alpha is the active VRF alpha_string input.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Alpha []byte `json:&quot;alpha,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // SubmitAfter is the block height after which nodes may submit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // VRF proofs for the current epoch.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SubmitAfter int64 `json:&quot;submit_after&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type VRFProve struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Epoch is the epoch that this VRF proof is for.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Epoch epochtime.EpochTime `json:&quot;epoch&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Pi is the VRF proof for the current epoch.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pi     []byte              `json:&quot;pi&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vrf-operation">VRF Operation<a class="hash-link" href="#vrf-operation" title="Direct link to heading">​</a></h3><p>For the genesis epoch, let the VRF alpha_string input be derived as:</p><p>  <code>TupleHash256((chain_context, I2OSP(epoch,8)), 256, &quot;oasis-core:vrf/alpha&quot;)</code></p><p>For every subsequent epoch, let alpha_string be derived as:</p><p>  <code>TupleHash256((chain_context, I2OSP(epoch, 8), beta_0, ... beta_n), 256, &quot;oasis-core:vrf/alpha&quot;)</code></p><p>where beta_0 through beta_n are the beta_string outputs gathered from
all valid pi_strings submitted during the previous epoch (after the
on-transition culling is complete), in ascending lexographic order by
VRF key.  If the number of beta values incorporated into the TupleHash
computation is greater than or equal to AlphaHighQuality threshold,
the alpha is considered &quot;strong&quot;, and committee elections are allowed
based on the proofs generated with this alpha.  If the alpha value is
weak (insufficient nodes submitted proofs), only validator elections
are allowed.</p><p>Upon receiving a VRFEvent, all eligible nodes MUST wait a minimum of
ProofSubmissionDelay blocks, and then submit a VRFProve transaction,
with the Proof field set to the output of
<code>ECVRF_prove(VRFKey_private, alpha_string)</code>.</p><p>Upon receiving a VRFProve transaction, the scheduler does the following:</p><ol><li><p>Rejects the transaction if less than ProofSubmissionDelay blocks
have elapsed since the transition into the current epoch.</p></li><li><p>Checks to see if the node tentatively eligible to be included in
the next election according to the following criteria:</p><ul><li><p>Not frozen.</p></li><li><p>Has registered the VRF.ID used to generate the proof prior
to the transition into the current epoch (May slash).</p></li><li><p>Has not already submitted a proof for the current epoch
(May slash if proof is different).</p></li></ul></li><li><p>Validates the proof, and if valid, stores the VRF.ID + pi_string
in the consensus state.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vrf-committee-elections">VRF Committee Elections<a class="hash-link" href="#vrf-committee-elections" title="Direct link to heading">​</a></h3><p>The following changes are made to the committee election process.</p><p>On epoch transition, as long as the alpha used to generate the proofs
is considered strong re-validate node eligibility for all nodes that
submitted a VRF proof (Not frozen, VRF.ID has not changed), and cull
proofs from nodes that are now ineligible.</p><p>If the alpha value is considered weak, no commitee elections are allowed.</p><p>For each committee:</p><ol><li><p>Filter the node list based on the current stake/eligibility criteria,
and additionally filter out nodes that have not submitted a valid
VRF proof.</p></li><li><p>For each eligible (node, commitee kind, committe role) tuple, derive
a sortition string as:</p></li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">`s_n = TupleHash256((chain_context, I2OSP(epoch, 8), runtime_id, I2OSP(kind, 1), I2OSP(role, 1), beta_n), 256, &quot;oasis-core:vrf/committee&quot;)`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li><p>Sort s_0 ... s_n in ascending lexographical order.</p></li><li><p>Select the requisite nodes that produced the sortition strings
starting from the head of the sorted list as the committee.</p></li></ol><p>Committee elections MUST be skipped for the genesis and subsequent epoch,
as the genesis epoch has no VRF proofs, and proofs submitted during the
genesis epoch are based on the bootstrap alpha_string.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vrf-validator-elections">VRF Validator Elections<a class="hash-link" href="#vrf-validator-elections" title="Direct link to heading">​</a></h3><p>The only place where the beacon is currently used in the validator selection
process is to pick a single node out of multiple eligible nodes controlled by
the same entity to become a validator.</p><p>When this situation occurs the validator is selected as follows:</p><ol><li>For all validator-eligible nodes controlled by the given entity,
derive a sortition string as:</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> `s_n = TupleHash256((chain_context, I2OSP(epoch, 8), beta_n), 256, &quot;oasis-core:vrf/validator&quot;)`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li><p>Sort s_0 ... s_n, in ascending lexographic order.</p></li><li><p>Select the node that produced the 0th sortition string in the sorted
list as the validator.</p></li></ol><p>This is safe to do with beta values generated via the bootstrap alpha string
as it is up to the entity running the nodes in question as to which ones
are a validator anyway.</p><p>As a concession for the transition process, if the number of validators
that submit proofs is less than the minimum number of validators configured
in the scheduler, validator tie-breaks (and only validator tie-breaks)
will be done by permuting the node list (as in the current PVSS beacon),
using entropy from the block hash.</p><p>As nodes are required to submit a VRF public key as part of non-genesis
registrations, and each node will attempt to submit a VRF proof, this
backward compatibility hack should only be triggered on the genesis
epoch, and can be removed on the next major upgrade.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="timekeeping-changes">Timekeeping Changes<a class="hash-link" href="#timekeeping-changes" title="Direct link to heading">​</a></h3><p>Timekeeping will go back to a fixed-interval epoch transition mechanism, with
all of the beacon related facilities removed.  As this is primarily a module
rename and code removal, the exact details are left unspecified.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a class="hash-link" href="#consequences" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive">Positive<a class="hash-link" href="#positive" title="Direct link to heading">​</a></h3><ul><li><p>This is significantly simpler from a design standpoint.</p></li><li><p>This is significantly faster and scales significantly better.</p></li><li><p>It is possible to go back to fixed-length epochs again.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative">Negative<a class="hash-link" href="#negative" title="Direct link to heading">​</a></h3><ul><li><p>The system loses a way to generate entropy at the consensus layer.</p></li><li><p>The simple design involves an additional 1-epoch period after network
initialization where elections are not available.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="neutral">Neutral<a class="hash-link" href="#neutral" title="Direct link to heading">​</a></h3><ul><li>I need to implement TupleHash256.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">​</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/oasisprotocol/adrs/edit/main/0010-vrf-elections.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-01-23T16:21:40.000Z">Jan 23, 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/adrs/0009-ed25519-semantics"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ADR 0009: Ed25519 Signature Verification Semantics</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/adrs/0011-incoming-runtime-messages"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ADR 0011: Incoming Runtime Messages</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#component" class="table-of-contents__link toc-highlight">Component</a></li><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#cryptographic-primitives" class="table-of-contents__link toc-highlight">Cryptographic Primitives</a></li><li><a href="#node-descriptor-changes" class="table-of-contents__link toc-highlight">Node Descriptor Changes</a></li><li><a href="#consensus-parameters" class="table-of-contents__link toc-highlight">Consensus Parameters</a></li><li><a href="#consensus-state-events-and-transactions" class="table-of-contents__link toc-highlight">Consensus State, Events, and Transactions</a></li><li><a href="#vrf-operation" class="table-of-contents__link toc-highlight">VRF Operation</a></li><li><a href="#vrf-committee-elections" class="table-of-contents__link toc-highlight">VRF Committee Elections</a></li><li><a href="#vrf-validator-elections" class="table-of-contents__link toc-highlight">VRF Validator Elections</a></li><li><a href="#timekeeping-changes" class="table-of-contents__link toc-highlight">Timekeeping Changes</a></li></ul></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li><li><a href="#neutral" class="table-of-contents__link toc-highlight">Neutral</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/pJdWeVtmHT" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Watch us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UC35UFPcZ2F1wjPxhPrSsESQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Oasis Protocol Foundation. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.df39c847.js"></script>
<script src="/assets/js/main.4ff8f277.js"></script>
</body>
</html>